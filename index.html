<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Najlepsze plaÅ¼e Teneryfy â€” interaktywna mapa</title>
  <!-- Minimal, robust setup: load Leaflet from a known-good CDN, then fall back if needed. -->
  <link id="leaflet-css" rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
  <script id="leaflet-js" src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous" defer></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }
    .legend { position: fixed; bottom: 20px; left: 20px; z-index: 9999; background: white; border: 1px solid #bbb; border-radius: 8px; padding: 10px 12px; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .legend .row { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .popup img { width: 100%; height: auto; border-radius: 8px; display: block; margin: 6px 0 8px; background:#f1f5f9; }
    .popup h4 { margin: 0 0 6px; font-size: 16px; }
    .popup p { margin: 4px 0; font-size: 13px; }
    .popup ul { margin: 0 0 8px 18px; padding: 0; font-size: 13px; }
    .btns { display: flex; gap: 8px; flex-wrap: wrap; }
    .btns a { text-decoration: none; padding: 6px 10px; border-radius: 6px; border: 1px solid #1a73e8; font-size: 13px; }
    .btns a.wiki { border-color: #0f766e; }
    .diag { position: fixed; top: 12px; left: 12px; z-index: 10000; background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 8px; padding: 8px 10px; font: 12px/1.4 system-ui; color: #0f172a; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .ok { color: #065f46; } .warn { color: #b45309; } .err { color: #991b1b; }
  </style>
</head>
<body>
  <div id="map" role="region" aria-label="Mapa najlepszych plaÅ¼ Teneryfy"></div>
  <div class="legend" aria-live="polite">
    <div><b>Legenda</b></div>
    <div class="row">ðŸ”µ Top plaÅ¼e (klasyki)</div>
    <div class="row">ðŸŸ¢ Sekretne/ukryte plaÅ¼e</div>
    <div style="font-size:12px;color:#555;">Kliknij zdjÄ™cie, aby otworzyÄ‡ artykuÅ‚ na angielskiej Wikipedii.</div>
  </div>
  <div class="diag" id="diag">
    <div><b>Status</b></div>
    <div id="status-leaflet">Leaflet: <span class="warn">oczekiwanieâ€¦</span></div>
    <div id="status-tiles">Kafelki OSM: <span class="warn">oczekiwanieâ€¦</span></div>
    <div id="status-markers">Markery/obrazy: <span class="warn">oczekiwanieâ€¦</span></div>
  </div>

  <script>
  (async function bootstrap() {
    // ---- Diagnostic helpers ----
    const diag = {
      leaflet: document.getElementById('status-leaflet'),
      tiles: document.getElementById('status-tiles'),
      markers: document.getElementById('status-markers')
    };
    const setLeafletStatus = (cls, msg) => diag.leaflet.innerHTML = `Leaflet: <span class="${cls}">${msg}</span>`;
    const setTilesStatus   = (cls, msg) => diag.tiles.innerHTML   = `Kafelki OSM: <span class="${cls}">${msg}</span>`;
    const setMarkersStatus = (cls, msg) => diag.markers.innerHTML = `Markery/obrazy: <span class="${cls}">${msg}</span>`;

    // ---- Load Leaflet with fallback if needed ----
    async function ensureLeafletLoaded() {
      if (window.L && typeof L.map === 'function') return true;
      // If primary CDN failed (blocked/mis-cached), try jsDelivr then cdnjs
      const fallbackJs = [
        'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js',
        'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js'
      ];
      const fallbackCss = [
        'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css',
        'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css'
      ];
      for (let i=0;i<fallbackJs.length;i++) {
        await new Promise(r => setTimeout(r, 150));
        if (window.L && typeof L.map === 'function') return true;
        const l = document.createElement('link'); l.rel = 'stylesheet'; l.href = fallbackCss[i]; document.head.appendChild(l);
        const s = document.createElement('script'); s.src = fallbackJs[i]; s.defer = true; document.head.appendChild(s);
        await new Promise(r => setTimeout(r, 600));
      }
      return (window.L && typeof L.map === 'function');
    }

    const okLeaflet = await ensureLeafletLoaded();
    if (!okLeaflet) { setLeafletStatus('err', 'bÅ‚Ä…d â€” nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ Leaflet'); return; }
    setLeafletStatus('ok', 'zaÅ‚adowano');

    try {
      // ---- Map init ----
      const map = L.map('map', { zoomControl: true }).setView([28.30, -16.60], 10);
      const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      });
      tiles.on('load', () => setTilesStatus('ok', 'OK'));
      tiles.on('tileerror', () => setTilesStatus('err', 'bÅ‚Ä…d (kafelki niedostÄ™pne)'));
      tiles.addTo(map);

      // ---- Marker icons (no external plugins) ----
      const BlueIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
      });
      const GreenIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
      });

      // ---- Data (with EN Wikipedia page titles for images & links) ----
      const TOP_BEACHES = [
        { name: 'Playa de Las Teresitas', wiki: 'Playa_de_Las_Teresitas', coords: [28.5079, -16.1870], access: 'Easy access, 10â€“15 min from Santa Cruz. Bus TITSA 910 (San AndrÃ©s).', parking: 'Large free parking along the beach; busy on weekends.', tips: ['Lifeguards and showers usually present.', 'Little shade â€” bring umbrella/SPF.', 'Breakwaters = calm water for families.', 'Arrive early on weekends.'] },
        { name: 'Playa de la Tejita', wiki: 'MontaÃ±a_Roja,_Tenerife', coords: [28.0405, -16.5415], access: 'Short walk from El MÃ©dano/MontaÃ±a Roja (5â€“10 min).', parking: 'Unpaved areas; windy and sandy.', tips: ['Strong wind â€” great for kite/surf, less for toddlers.', 'Limited infrastructure & no permanent shade.', 'Naturist zones closer to MontaÃ±a Roja.', 'Mind sand/dust on windy days.'] },
        { name: 'Playa de Benijo', wiki: 'Taganana', coords: [28.5767, -16.1863], access: 'Drive TFâ€‘134, descend via steep path/stairs.', parking: 'Few spots by the road/restaurants â€” come early.', tips: ['No breakwaters & strong surf â€” not for beginners.', 'Check tides â€” at high tide the beach shrinks.', 'Best light: sunset.', 'Bring water & snacks â€” few services on the beach.'] },
        { name: 'Playa de los GuÃ­os (Los Gigantes)', wiki: 'Los_Gigantes', coords: [28.2422, -16.8412], access: 'In town centre, a few minutes from the marina.', parking: 'Paid/street parking; scarce in high season.', tips: ['At high tide the sandy area is small â€” come early.', 'Sheltered cove but some current possible.', 'Shops & bars nearby.', 'Great spot for boat trips along the cliffs.'] }
      ];

      const SECRET_BEACHES = [
        { name: 'Playa de Antequera', wiki: 'Anaga_Rural_Park', coords: [28.5655, -16.1350], access: 'Long demanding hike from Anaga or boat from San AndrÃ©s (sea permitting).', parking: 'Park at San AndrÃ©s (boat) or at the trailhead (limited).', tips: ['Check tides & swell â€” more sand at low tide.', 'No lifeguards/infrastructure â€” wild.', 'Hiking shoes & water a must.', 'Sun can be harsh â€” hat/umbrella advised.'] },
        { name: 'Playa Diego HernÃ¡ndez (La Caleta)', wiki: 'La_Caleta,_Adeje', coords: [28.1098, -16.7595], access: '15â€“20 min coastal path from La Caleta; rocky/eroded sections.', parking: 'Street parking in La Caleta; fills up fast on weekends.', tips: ['Occasionally closed during heavy swell/works â€” check on site.', 'No facilities; bring water and a trash bag.', 'Rocky seabed â€” water shoes help.', 'Watch for rising tide (less sand).'] },
        { name: 'Playa de Abama', wiki: 'GuÃ­a_de_Isora', coords: [28.1408, -16.8072], access: 'Through the Abama complex; footpath or elevator (not always operating).', parking: 'Along the access road and lay-bys; limited.', tips: ['Sheltered cove â€” good for kids.', 'Crowded in season â€” arrive early.', 'South wind can bring small waves â€” watch kids.', 'Cafe & toilets usually up by the elevator.'] }
      ];

      // ---- Helpers ----
      const gmapsLink = ([lat, lon]) => `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
      const wikiArticle = (title) => `https://en.wikipedia.org/wiki/${encodeURIComponent(title)}`;
      function buildPopupHTML(b, imgSrc) {
        const tips = (b.tips || []).map(t => `<li>${t}</li>`).join('');
        const wikiUrl = wikiArticle(b.wiki);
        const imgHtml = imgSrc ? `<img src="${imgSrc}" alt="${b.name}" loading="eager">` : `<div style="height:180px;border-radius:8px;background:#e2e8f0;display:flex;align-items:center;justify-content:center;">No image</div>`;
        return `
          <div class="popup" style="width:320px;">
            <h4>${b.name}</h4>
            <a href="${wikiUrl}" target="_blank" rel="noopener">${imgHtml}</a>
            <p><b>Access:</b> ${b.access}</p>
            <p><b>Parking:</b> ${b.parking}</p>
            <p><b>Key tips:</b></p>
            <ul>${tips}</ul>
            <div class="btns">
              <a class="wiki" href="${wikiUrl}" target="_blank" rel="noopener">Wikipedia (EN)</a>
              <a href="${gmapsLink(b.coords)}" target="_blank" rel="noopener">Open in Google Maps</a>
            </div>
          </div>`;
      }

      // ---- Image fetching (Wikipedia first, then Wikimedia Commons) ----
      async function fetchFromWikipediaSummary(title) {
        try {
          const resp = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`);
          if (!resp.ok) return null;
          const data = await resp.json();
          return (data.originalimage && data.originalimage.source) || (data.thumbnail && data.thumbnail.source) || null;
        } catch { return null; }
      }
      async function fetchFromWikipediaMediaList(title) {
        try {
          const resp = await fetch(`https://en.wikipedia.org/api/rest_v1/page/media-list/${encodeURIComponent(title)}`);
          if (!resp.ok) return null;
          const data = await resp.json();
          if (!data || !Array.isArray(data.items)) return null;
          const imgItem = data.items.find(it => it.type === 'image' && (it.srcset?.length || it.src));
          if (!imgItem) return null;
          // Prefer largest srcset
          if (Array.isArray(imgItem.srcset) && imgItem.srcset.length) {
            const sorted = [...imgItem.srcset].sort((a,b)=> (b.scale||0) - (a.scale||0));
            return sorted[0].src || imgItem.srcset[0].src;
          }
          return imgItem.src || null;
        } catch { return null; }
      }
      async function fetchFromCommonsSearch(query) {
        try {
          const resp = await fetch(`https://commons.wikimedia.org/w/api.php?action=query&format=json&origin=*&generator=search&gsrnamespace=6&gsrlimit=5&gsrsearch=${encodeURIComponent(query)}&prop=imageinfo&iiprop=url&iiurlwidth=1200`);
          if (!resp.ok) return null;
          const data = await resp.json();
          const pages = data?.query?.pages;
          if (!pages) return null;
          const first = Object.values(pages).find(p => Array.isArray(p.imageinfo) && p.imageinfo.length);
          return first?.imageinfo?.[0]?.thumburl || first?.imageinfo?.[0]?.url || null;
        } catch { return null; }
      }
      async function fetchBestImage(title) {
        // Try Wikipedia article first
        let img = await fetchFromWikipediaSummary(title);
        if (img) return { url: img, source: 'wikipedia:summary' };
        img = await fetchFromWikipediaMediaList(title);
        if (img) return { url: img, source: 'wikipedia:media-list' };
        // Fallback to Wikimedia Commons search using human-readable query
        const query = title.replace(/_/g,' ');
        img = await fetchFromCommonsSearch(query);
        if (img) return { url: img, source: 'commons:search' };
        return { url: null, source: 'none' };
      }

      // Preload images for all entries
      const all = [...TOP_BEACHES, ...SECRET_BEACHES];
      const imgCache = {}; const imgSource = {};
      let wikiResolved = 0, commonsResolved = 0, missing = 0;
      await Promise.all(all.map(async (b) => {
        const res = await fetchBestImage(b.wiki);
        imgCache[b.name] = res.url; imgSource[b.name] = res.source;
        if (res.source.startsWith('wikipedia')) wikiResolved++;
        else if (res.source.startsWith('commons')) commonsResolved++;
        else missing++;
      }));

      // Layers
      const topLayer = L.layerGroup();
      const secretLayer = L.layerGroup();
      TOP_BEACHES.forEach(b => L.marker(b.coords, { icon: BlueIcon  }).bindPopup(buildPopupHTML(b, imgCache[b.name])).addTo(topLayer));
      SECRET_BEACHES.forEach(b => L.marker(b.coords, { icon: GreenIcon }).bindPopup(buildPopupHTML(b, imgCache[b.name])).addTo(secretLayer));
      topLayer.addTo(map);
      secretLayer.addTo(map);
      L.control.layers(null, { 'Top plaÅ¼e (klasyki)': topLayer, 'Sekretne/ukryte plaÅ¼e': secretLayer }, { collapsed: false }).addTo(map);

      // Fit bounds
      const bounds = L.latLngBounds(all.map(b => b.coords));
      map.fitBounds(bounds, { padding: [30, 30] });

      // ---- Simple runtime tests ("test cases") ----
      console.assert(map instanceof L.Map, 'Map should be instance of L.Map');
      console.assert(topLayer.getLayers().length === TOP_BEACHES.length, 'Top layer marker count mismatch');
      console.assert(secretLayer.getLayers().length === SECRET_BEACHES.length, 'Secret layer marker count mismatch');
      const loadedImages = Object.values(imgCache).filter(Boolean).length;
      console.assert(loadedImages >= 3, 'At least 3 Wikipedia images should be resolved');
      console.log('Diagnostics:', { loadedImages, total: all.length });
      setMarkersStatus('ok', `OK (images total: ${Object.values(imgCache).filter(Boolean).length}/${all.length}; wiki: ${wikiResolved}, commons: ${commonsResolved}, missing: ${missing})`);
    } catch (err) {
      console.error('BÅ‚Ä…d inicjalizacji mapy:', err);
      setMarkersStatus('err', 'bÅ‚Ä…d inicjalizacji');
    }
  })();
  </script>
</body>
</html>
